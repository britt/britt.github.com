#!/usr/bin/env node --harmony 

const FS = require('fs')
const TOML = require('toml-js')
const request = require('superagent')
const moment = require('moment')
const program = require('commander')

function quit() {
  process.exit(0)
}

function logAndQuit(error) {
  process.stderr.write(error.toString())
  process.exit(1)
}

function thereIsNoTry(callback) {
  return (err, data) => {
    if(err) {
      logAndQuit(err)
    } else {
      callback(data)
    }
  }
}

function startOfWeekAsMoment(dateString) {
  const m = moment(dateString, 'YYYY-MM-DD')
  return m.startOf('week')
}

function fetchAndSaveWeeklyReads(startOfWeek, data) {
  const config = TOML.parse(data)
  const url = config.reading.api_url
  const nextWeek = moment(startOfWeek).add(1, 'week').subtract(1, 'minute')

  request.get(url).end(thereIsNoTry((res) => {
    const data = JSON.parse(res.text)

    const thisWeeksReads = data.result.filter((item) => {
      const date_liked = moment(item['date_liked'], "MMMM DD, YYYY at hh:mmA")
      return date_liked.isBetween(startOfWeek, nextWeek)
    })

    const readingData = {
      title: " Reading Notes for " + startOfWeek.format("MMMM DD, YYYY"),
      articles: thisWeeksReads
    }

    const outputPath = "./pages/reading/" + startOfWeek.format("YYYY-MM-DD")
    const outputFileName = outputPath + "/index.json"
    
    const saveReads = () => {
      FS.writeFile(outputFileName, JSON.stringify(readingData), thereIsNoTry(quit))
    }

    FS.access(outputPath, FS.F_OK, (err) => {
      if(err) {
        FS.mkdir(outputPath, thereIsNoTry(saveReads))
      } else {
        saveReads()
      }
    })
  }))
}

program.version('0.0.1')
  .option('-a, --all', 'Fetch all')
  .option('-w, --week <week>', 'Fetch data for a given week', startOfWeekAsMoment)
  .parse(process.argv)

if(program.all) {
  logAndQuit("Fetch all not implemented.")
} else if(program.week) {
  FS.readFile('config.toml', 
    thereIsNoTry(fetchAndSaveWeeklyReads.bind(this, program.week)))
} else {
  FS.readFile('config.toml', 
    thereIsNoTry(fetchAndSaveWeeklyReads.bind(this, moment().startOf('week'))))
}

