'use strict';

var _glob = require('glob');

var _glob2 = _interopRequireDefault(_glob);

var _buildPage = require('./build-page');

var _buildPage2 = _interopRequireDefault(_buildPage);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var debug = require('debug')('gatsby:glob');

function globQuery(directory) {
  // Make this list easy to modify through the config?
  // Or just keep adding extensions...?
  var fileTypesToGlob = ['coffee', 'cjsx', 'jsx', 'js', 'md', 'html', 'json', 'yaml', 'toml'];
  var fileGlobQuery = fileTypesToGlob.map(function (type) {
    return '*.' + type;
  });
  var joinedFileQuery = fileGlobQuery.join('|');
  return directory + '/pages/**/?(' + joinedFileQuery + ')';
}

var globCache = void 0;
function createCache(directory, callback) {
  var pagesData = [];

  (0, _glob2.default)(globQuery(directory), null, function (err, pages) {
    if (err) {
      return callback(err);
    }

    pages.forEach(function (page) {
      pagesData.push((0, _buildPage2.default)(directory, page));
    });

    debug('globbed ' + pagesData.length + ' pages');
    globCache = pagesData;
    return callback(null, pagesData);
  });
}

module.exports = function globPages(directory, callback) {
  if (typeof globCache === 'undefined') {
    createCache(directory, callback);
  } else {
    callback(null, globCache);
  }
};